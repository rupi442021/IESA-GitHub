<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="../Scripts/GeneralFunctions.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="../Scripts/GeneralFunctions.js"></script>
    <script src="../Scripts/jquery-3.4.1.min.js"></script>

    <title>&#x202E; הוספת פוסט – ASEI</title>
    <link rel="icon" href="https://iesa.org.il/wp-content/uploads/2020/04/cropped-favic-32x32.png">


    <style type="text/css">

        /*Template Style*/
        body {
            background-color: #212529;
            color: white;
        }

        .container {
            background-color: #292e38;
            max-width: 1110px;
            height: 2000px;
            padding-top: 30px;
        }

        .jumbotron {
            height: 70px;
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
        }

        /*Page title Open*/

        .titlelink {
            color: #FFFFFF;
            text-decoration: none;
            margin: 3px;
            font-weight: 600;
            font-size: 1.04rem;
            letter-spacing: .015em;
            line-height: 2;
        }

            .titlelink:hover {
                color: #04b8a5;
                transition: .15s color;
            }

        .headh2 {
            display: flex;
            align-items: center;
            /*margin-bottom: 55px;*/ /*#1*/
            font-weight: 600;
            letter-spacing: .015em;
            margin: 3px; /*#2*/
        }

            .headh2::after {
                content: '';
                flex: 1;
                margin-right: 10px;
                margin-top: 23px;
                opacity: 0.84;
                height: 2px;
                background-color: #fff;
            }

        .divdown {
            margin-bottom: 50px;
        }

        /*Page title Close*/

        /*Template Style*/

        #charNum {
            direction: ltr;
            color: dimgray;
            font-size: 15px;
        }

        .logofilePH > img {
            max-height: 250px;
            max-width: 950px;
        }

        .bannerfilePH > img {
            max-height: 350px;
            max-width: 300px;
        }

        .noteforfiles {
            font-size: 12px;
        }

        img {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 3px;
            background-color: #F0FFFF;
            width: 100%;
            height: 200px !important;
        }


    </style>

    <script>

        $(document).ready(function () {

            counterimage = 3300;

            $("#pForm").submit(function (e) {
                e.preventDefault();
                getPostId();
            });

            $("#logoFile").change(function () {
                addPreview();
            });

        });


        function init() {

            if (localStorage["user_type"] != "1") {

                location.replace("TemplatePage.html"); //wont allow other users to be on this page
            }

        }

        function getPostId() {

            ajaxCall("GET", "../api/Posts", "", getSuccessId, getErrorId); //method OP1
        }

        function getSuccessId(id) { //get the id of the new post
            console.log(id);

            var postid = parseInt(id);

            addPhoto(postid);
        }

        function getErrorId(err) {
            console.log(err.responseJSON.ExceptionMessage);

            alert(err.responseJSON.ExceptionMessage);
        }


        function addPhoto(postid) {

            var data = new FormData();

            var files = $("#logoFile").get(0).files;

            // Add the uploaded file to the form data collection
            if (files.length > 0) {
                for (f = 0; f < files.length; f++) {
                    data.append("UploadedImage", files[f]);
                }

                data.append("userid", postid); //append what ever data you want to send along with the files.
            }

            // Ajax upload
            $.ajax({
                type: "POST",
                url: "../Api/FileUpload",
                contentType: false,
                processData: false,
                data: data,
                success: addPost,
                error: error
            });

        }

        function addPost(imageURL) {

            let photoUpload = imageURL[0];

            PostObj = {
                Title: $("#titleTB").val(),
                Body: $("#bodyTB").val(),
                Image1: photoUpload,
                Category: $("#categoriesTB").val(),
                Postdate: getDate(),
                Status1: 1 //DEFAULT Post Active
            }

            ajaxCall("POST", "../api/Posts", JSON.stringify(PostObj), SuccessInsert, ErrorInsert); //method OP2
        }

        function SuccessInsert(data) {
            console.log("in Success");

            swal("פוסט נוצר בהצלחה", "", "success");

            setTimeout(function () {
                window.close();
            }, 2500);
        }


        function ErrorInsert(err) {
            console.log(err.responseJSON.ExceptionMessage);

            alert(err.responseJSON.ExceptionMessage); //Message - throw new exception from the server*
        }


        function addPreview() {

            counterimage = counterimage + 1;

            if (counterimage > 3302) { //Security: User Wont be able to upload more then 3 pictures to the server
                counterimage = 3300;
            }

            var data = new FormData();

            var files = $("#logoFile").get(0).files;

            // Add the uploaded file to the form data collection
            if (files.length > 0) {
                for (f = 0; f < files.length; f++) {
                    data.append("UploadedImage", files[f]);
                }

                data.append("userid", counterimage); //append what ever data you want to send along with the files.
            }

            // Ajax upload
            $.ajax({
                type: "POST",
                url: "../Api/FileUpload",
                contentType: false,
                processData: false,
                data: data,
                success: imagePreview,
                error: error
            });


        }


        function imagePreview(data) {

            var imgStr = "";

            if (Array.isArray(data)) {
                for (var i = 0; i < data.length; i++) {
                    imgStr = "<img src='../" + data[i] + "' alt='Logo'/>";
                }
            }
            else {
                imgStr = "<img src='../" + data + "'/>";
            }

            document.getElementById("ph").innerHTML = imgStr;
        }

        function error(err) {
            console.log(err);

            alert(err);
        }


    </script>

</head>
<body onload="init()">

    <section id="Nav-bar">
        <div class="jumbotron jumbotron-fluid" style="background-color:#04b8a5;">
        </div>
    </section>

    <section id="content">

        <div class="container">

            <section id="page_title">
                <a class="titlelink" href="TemplatePage.html">ניהול מערכת </a>
                <svg style="width: .5em; transform: rotate(180deg); vertical-align: -.17em;" svg-inline--fa fa-angle-right fa-w-8" aria-hidden="true" focusable="false" data-prefix="fa" data-icon="angle-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><path fill="currentColor" d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"></path></svg>
                <a class="titlelink" href="TemplatePage.html">פוסטים </a>
                <svg style="width: .5em; transform: rotate(180deg); vertical-align: -.17em;" svg-inline--fa fa-angle-right fa-w-8" aria-hidden="true" focusable="false" data-prefix="fa" data-icon="angle-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><path fill="currentColor" d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"></path></svg>
                <h2 class="headh2">הוספת פוסט חדש</h2>
                <div class="divdown"></div>
            </section>

            <p>* מיקום הפוסט יהיה ניתן לשינוי בדף דאשבורד מנהל</p> <br>

            <h4 style="color:white">הזנת שדות פוסט</h4><br>

            <form id="pForm" class="was-validated">
                <div class="row">
                    <div class="col">

                        <div class="mb-3">
                            <label>כותרת:</label>
                            <input type="text" class="form-control" id="titleTB" pattern=".{4,40}"
                                   oninvalid="this.setCustomValidity('עד 40 תווים')"
                                   oninput="this.setCustomValidity('')" required>
                        </div>
                    </div>
                    <div class="col">


                        <div class="mb-3">
                            <label>קטגורייה:</label><br />
                            <select name="gamecategories" class="form-select" id="categoriesTB" required>
                                <option hidden selected></option>
                                <option value="כללי">כללי</option>
                                <option value="עולמי">עולמי</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">

                    <div class="col">


                        <div class="mb-3">
                            <label>גוף הפוסט:</label>
                            <textarea class="form-control" id="bodyTB" placeholder="הזן טקסט כאן" pattern=".{4,3999}"
                                      oninvalid="this.setCustomValidity('עד 4000 תווים')" rows="7" required></textarea>
                            <div id="charNum"></div> <!--this div show how many chars we used in textarea-->
                        </div>

                    </div>

                </div>

                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <div class="form-group" method="post" enctype="multipart/form-data" id="formUpload">
                                <label for="file">לוגו פוסט: </label>
                                <br />
                                <input type="file" id="logoFile" name="files" multiple="multiple" />
                                <p class="noteforfiles">הגודל המומלץ ללוגו 808x400</p>
                            </div>
                        </div>

                    </div>
                    <div class="col">
                        <label>תצוגה מקדימה: </label>
                        <div id="ph">
                            <img src="https://i.imagesup.co/images2/825f9efa6c0956d118a1902c75f35529db52189f.jpg" class="img-fluid" alt="Logo">
                        </div>

                    </div>
                </div>


                <div class="row" dir="ltr">

                    <div class="col" style="margin-left:25px;">
                        <br /><br />

                        <!--<input type="button" class="btn btn-danger" value="תצוגה מקדימה" id="previewC" />-->
                        <input type="submit" class="btn btn-success" value="הוספת פוסט" onsubmit="return false" />
                        <input type="button" class="btn btn-danger" value="ביטול" onclick="window.close();" />

                    </div>
                </div>

            </form>

        </div>

    </section>


    <section id="site_footer">
        <div class="jumbotron jumbotron-fluid" style="background-color:#1a1a1a;">
            <h2>IESA</h2>
        </div>
    </section>


</body>
</html>